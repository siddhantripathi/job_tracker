name: ðŸ‘€ PR Preview Deployment

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [closed]

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: 'jobtrack-app'

jobs:
  # Job 1: Deploy Preview
  deploy-preview:
    name: ðŸš€ Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    environment: preview
    
    outputs:
      preview-url: ${{ steps.preview-deploy.outputs.details_url }}
      channel-id: ${{ steps.preview-deploy.outputs.channel_id }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci
        cd functions && npm ci
        cd ../frontend && npm ci --legacy-peer-deps
        
    - name: ðŸ—ï¸ Build Application
      working-directory: ./frontend
      run: npm run build
      env:
        REACT_APP_FIREBASE_API_KEY: ${{ secrets.REACT_APP_FIREBASE_API_KEY }}
        REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}
        REACT_APP_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        
    - name: ðŸ”¥ Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: ðŸ” Authenticate Firebase
      run: echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login:ci --token-stdin
      
    - name: ðŸš€ Deploy to Preview Channel
      id: preview-deploy
      run: |
        CHANNEL_ID="pr-${{ github.event.number }}"
        firebase use ${{ env.FIREBASE_PROJECT_ID }}
        
        # Deploy to preview channel
        firebase hosting:channel:deploy $CHANNEL_ID \
          --expires 7d \
          --json > deploy_result.json
          
        # Extract URL from result
        PREVIEW_URL=$(cat deploy_result.json | jq -r '.result.url')
        echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        echo "channel_id=$CHANNEL_ID" >> $GITHUB_OUTPUT
        
        echo "ðŸŒ Preview deployed to: $PREVIEW_URL"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ðŸ“Š Update PR Status
      run: |
        echo "### ðŸš€ Preview Deployment Ready!" >> $GITHUB_STEP_SUMMARY
        echo "- **Preview URL**: ${{ steps.preview-deploy.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Channel ID**: ${{ steps.preview-deploy.outputs.channel_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Expires**: 7 days" >> $GITHUB_STEP_SUMMARY

  # Job 2: Run Preview Tests
  preview-tests:
    name: ðŸ§ª Preview Tests
    runs-on: ubuntu-latest
    needs: deploy-preview
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”— Health Check
      run: |
        echo "Testing preview deployment..."
        curl -f "${{ needs.deploy-preview.outputs.preview-url }}" || exit 1
        
    - name: ðŸƒ Lighthouse Performance Test
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ needs.deploy-preview.outputs.preview-url }}
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: ðŸ“Š Performance Report
      run: |
        echo "### ðŸ“Š Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "Lighthouse tests completed for preview deployment" >> $GITHUB_STEP_SUMMARY

  # Job 3: Comment on PR
  comment-pr:
    name: ðŸ’¬ Comment on PR
    runs-on: ubuntu-latest
    needs: [deploy-preview, preview-tests]
    if: github.event.action != 'closed'
    
    steps:
    - name: ðŸ’¬ Create PR Comment
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## ðŸš€ Preview Deployment Ready!
          
          Your changes have been deployed to a preview environment:
          
          **ðŸŒ Preview URL:** ${{ needs.deploy-preview.outputs.preview-url }}
          **â° Expires:** 7 days from now
          **ðŸ”„ Auto-updates:** Yes (on new commits)
          
          ### ðŸ§ª Test Results
          - âœ… Health check passed
          - ðŸƒ Lighthouse performance test completed
          
          ### ðŸ“± Test on Different Devices
          You can test the preview on:
          - ðŸ’» Desktop browsers
          - ðŸ“± Mobile devices
          - ðŸ§ª Different screen sizes
          
          ### ðŸ”§ Need to make changes?
          Just push new commits to this PR branch and the preview will auto-update!
          
          ---
          *This preview will be automatically cleaned up when the PR is closed.*`;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

  # Job 4: Cleanup Closed PR
  cleanup-preview:
    name: ðŸ§¹ Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”¥ Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: ðŸ” Authenticate Firebase
      run: echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login:ci --token-stdin
      
    - name: ðŸ§¹ Delete Preview Channel
      run: |
        CHANNEL_ID="pr-${{ github.event.number }}"
        firebase use ${{ env.FIREBASE_PROJECT_ID }}
        
        # Delete the preview channel
        firebase hosting:channel:delete $CHANNEL_ID --force || echo "Channel already deleted"
        
        echo "ðŸ§¹ Preview channel $CHANNEL_ID deleted"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ðŸ’¬ Update PR Comment
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## ðŸ§¹ Preview Deployment Cleaned Up
          
          The preview deployment for this PR has been automatically cleaned up.
          
          **Status:** âœ… Resources freed
          **Action:** Preview channel deleted
          
          Thank you for contributing to JobTrack! ðŸŽ‰`;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

  # Job 5: Security Check for External PRs
  security-check:
    name: ðŸ”’ Security Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name != github.repository
    
    steps:
    - name: ðŸ”’ External PR Security Check
      run: |
        echo "ðŸ”’ This is an external PR - running additional security checks"
        echo "âš ï¸ External PR detected from: ${{ github.event.pull_request.head.repo.full_name }}"
        echo "ðŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        
        # Add additional security checks here
        # For example: check for suspicious file changes, validate dependencies, etc.
        
    - name: ðŸ“‹ Security Report
      run: |
        echo "### ðŸ”’ Security Check Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Basic security checks passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **Note**: This is an external contribution. Please review carefully before merging." >> $GITHUB_STEP_SUMMARY 